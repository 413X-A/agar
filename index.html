<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Agar.io Clone</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #111;
    }
    canvas {
      display: block;
      background-color: #222;
      touch-action: none;
    }
    #score {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font: bold 18px Arial;
      z-index: 10;
    }
    #joystick, #splitBtn {
      position: absolute;
      bottom: 20px;
      background: rgba(255,255,255,0.1);
      border: 2px solid #888;
      border-radius: 50%;
      touch-action: none;
    }
    #joystick {
      width: 120px;
      height: 120px;
      left: 20px;
    }
    #splitBtn {
      width: 80px;
      height: 80px;
      right: 20px;
      color: white;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div id="score">Score: 20</div>
  <canvas id="gameCanvas"></canvas>
  <div id="joystick"></div>
  <div id="splitBtn">SPLIT</div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const world = { width: 4000, height: 4000 };
    let score = 20;

    const playerParts = [{
      x: world.width / 2,
      y: world.height / 2,
      radius: getRadiusFromScore(score),
      vx: 0,
      vy: 0,
      mergeTimeout: 0,
      score: score
    }];

    const bots = [];
    const food = [];

    function getRadiusFromScore(s) {
      return Math.sqrt(s) + 5;
    }

    function randomColor() {
      return `hsl(${Math.random() * 360}, 70%, 50%)`;
    }

    function createFood(n) {
      for (let i = 0; i < n; i++) {
        food.push({
          x: Math.random() * world.width,
          y: Math.random() * world.height,
          radius: 4,
          color: "yellow"
        });
      }
    }

    function createBots(n) {
      for (let i = 0; i < n; i++) {
        bots.push({
          x: Math.random() * world.width,
          y: Math.random() * world.height,
          radius: 20 + Math.random() * 40,
          color: randomColor(),
          target: null,
          speed: 1.2
        });
      }
    }

    let joystick = { x: 0, y: 0 };
    let mouseX = 0, mouseY = 0;
    let useJoystick = false;

    const joystickElem = document.getElementById("joystick");
    joystickElem.addEventListener("touchmove", e => {
      useJoystick = true;
      const rect = joystickElem.getBoundingClientRect();
      const touch = e.touches[0];
      joystick.x = ((touch.clientX - rect.left) - 60) / 60;
      joystick.y = ((touch.clientY - rect.top) - 60) / 60;
    });
    joystickElem.addEventListener("touchend", () => {
      joystick.x = 0;
      joystick.y = 0;
    });

    window.addEventListener("mousemove", e => {
      mouseX = e.clientX;
      mouseY = e.clientY;
    });

    document.getElementById("splitBtn").addEventListener("click", () => {
      if (playerParts.length < 6 && score >= 40) {
        const main = playerParts[0];
        const angle = getInputAngle();
        const splitScore = Math.floor(score / 2);
        const splitRadius = getRadiusFromScore(splitScore);
        const offset = splitRadius + 5;

        const part1 = {
          x: main.x + Math.cos(angle) * offset,
          y: main.y + Math.sin(angle) * offset,
          radius: splitRadius,
          vx: Math.cos(angle) * 6,
          vy: Math.sin(angle) * 6,
          mergeTimeout: 300,
          score: splitScore
        };
        const part2 = {
          x: main.x - Math.cos(angle) * offset,
          y: main.y - Math.sin(angle) * offset,
          radius: splitRadius,
          vx: -Math.cos(angle) * 6,
          vy: -Math.sin(angle) * 6,
          mergeTimeout: 300,
          score: splitScore
        };

        playerParts.splice(0, 1);
        playerParts.push(part1, part2);
        score = splitScore * 2;
      }
    });

    function getInputAngle() {
      if (useJoystick) return Math.atan2(joystick.y, joystick.x);
      return Math.atan2(mouseY - canvas.height / 2, mouseX - canvas.width / 2);
    }

    function distance(a, b) {
      return Math.hypot(a.x - b.x, a.y - b.y);
    }

    function updateCamera() {
      const center = playerParts[0];
      return {
        x: center.x - canvas.width / 2,
        y: center.y - canvas.height / 2
      };
    }

    function drawCircle(obj, cam) {
      ctx.beginPath();
      ctx.arc(obj.x - cam.x, obj.y - cam.y, obj.radius, 0, Math.PI * 2);
      ctx.fillStyle = obj.color || "lime";
      ctx.fill();

      const partScore = obj.score ? Math.floor(obj.score) : Math.floor(score);
      ctx.fillStyle = "white";
      ctx.font = "14px Arial";
      ctx.textAlign = "center";
      ctx.fillText(partScore, obj.x - cam.x, obj.y - cam.y + 4);
    }

    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const cam = updateCamera();

      ctx.strokeStyle = "#666";
      ctx.lineWidth = 20;
      ctx.strokeRect(-cam.x, -cam.y, world.width, world.height);

      playerParts.forEach(part => {
        if (part.mergeTimeout > 0) part.mergeTimeout--;

        if (part.vx || part.vy) {
          part.x += part.vx;
          part.y += part.vy;
          part.vx *= 0.9;
          part.vy *= 0.9;
        } else {
          const angle = getInputAngle();
          const speed = Math.max(0.6, 3 * (20 / part.radius));
          part.x += Math.cos(angle) * speed;
          part.y += Math.sin(angle) * speed;
        }

        part.x = Math.max(part.radius, Math.min(world.width - part.radius, part.x));
        part.y = Math.max(part.radius, Math.min(world.height - part.radius, part.y));
      });

      for (let i = playerParts.length - 1; i >= 1; i--) {
        const a = playerParts[0];
        const b = playerParts[i];
        if (b.mergeTimeout <= 0 && distance(a, b) < a.radius + b.radius) {
          a.score += b.score;
          a.radius = getRadiusFromScore(a.score);
          playerParts.splice(i, 1);
        }
      }

      playerParts.forEach(part => {
        for (let i = food.length - 1; i >= 0; i--) {
          if (distance(part, food[i]) < part.radius) {
            food.splice(i, 1);
            part.score += 1;
            part.radius = getRadiusFromScore(part.score);
            food.push({
              x: Math.random() * world.width,
              y: Math.random() * world.height,
              radius: 4,
              color: "yellow"
            });
          }
        }
      });

      bots.forEach(bot => {
        let flee = false;
        playerParts.forEach(part => {
          if (distance(bot, part) < 250 && bot.radius < part.radius) {
            const angle = Math.atan2(bot.y - part.y, bot.x - part.x);
            bot.x += Math.cos(angle) * bot.speed;
            bot.y += Math.sin(angle) * bot.speed;
            flee = true;
          }
        });

        if (!flee) {
          if (!bot.target || distance(bot, bot.target) < 5) {
            bot.target = food[Math.floor(Math.random() * food.length)];
          }
          if (bot.target) {
            const angle = Math.atan2(bot.target.y - bot.y, bot.target.x - bot.x);
            bot.x += Math.cos(angle) * bot.speed;
            bot.y += Math.sin(angle) * bot.speed;
          }
        }

        for (let i = food.length - 1; i >= 0; i--) {
          if (distance(bot, food[i]) < bot.radius) {
            food.splice(i, 1);
            bot.radius += 0.2;
            food.push({
              x: Math.random() * world.width,
              y: Math.random() * world.height,
              radius: 4,
              color: "yellow"
            });
          }
        }

        playerParts.forEach(part => {
          if (distance(part, bot) < part.radius + bot.radius) {
            if (part.radius > bot.radius + 2) {
              bots.splice(bots.indexOf(bot), 1);
              part.score += Math.floor(bot.radius);
              part.radius = getRadiusFromScore(part.score);
            } else if (bot.radius > part.radius + 2) {
              alert("Game Over! Dein Score: " + score);
              location.reload();
            }
          }
        });

        drawCircle(bot, cam);
      });

      food.forEach(f => drawCircle(f, cam));
      playerParts.forEach(p => drawCircle(p, cam));

      score = playerParts.reduce((sum, p) => sum + (p.score || 0), 0);
      document.getElementById("score").innerText = "Score: " + score;

      requestAnimationFrame(animate);
    }

    createFood(1000);
    createBots(25);
    animate();
  </script>
</body>
</html>
